<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fantasy Pawns League</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #1a1a1a;
            color: #e5e5e5;
            line-height: 1.6;
            min-height: 100vh;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        h1 {
            font-size: 28px;
            font-weight: 300;
            letter-spacing: 2px;
            text-align: center;
            margin-bottom: 40px;
            color: #fff;
        }

        h2 {
            font-size: 18px;
            font-weight: 400;
            margin-bottom: 24px;
            color: #999;
        }

        h3 {
            font-size: 14px;
            font-weight: 500;
            letter-spacing: 1px;
            margin-bottom: 12px;
            text-transform: uppercase;
            color: #888;
        }

        .screen {
            display: none;
        }

        .screen.active {
            display: block;
        }

        /* Header Stats */
        .header-stats {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-bottom: 30px;
            font-size: 13px;
            color: #666;
        }

        .header-stats span {
            color: #fff;
            font-weight: 500;
        }

        /* Menu Screen */
        .league-badge {
            text-align: center;
            margin-bottom: 40px;
            padding: 20px;
            background: #202020;
            border: 1px solid #333;
        }

        .league-name {
            font-size: 24px;
            font-weight: 300;
            color: #fff;
            margin-bottom: 8px;
        }

        .league-record {
            font-size: 14px;
            color: #666;
        }

        .season-warning {
            background: #2a2520;
            border: 1px solid #4a4030;
            padding: 12px;
            margin-top: 12px;
            font-size: 12px;
            color: #a09070;
        }

        .menu-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            max-width: 700px;
            margin: 0 auto 20px;
        }

        .menu-btn {
            background: #252525;
            border: 1px solid #333;
            padding: 30px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .menu-btn:hover {
            background: #2a2a2a;
            border-color: #555;
        }

        .menu-btn h3 {
            font-size: 14px;
            font-weight: 500;
            letter-spacing: 1px;
            margin-bottom: 8px;
            text-transform: uppercase;
            color: #fff;
        }

        .menu-btn p {
            font-size: 12px;
            color: #666;
        }

        .menu-btn.danger {
            border-color: #4a3030;
            background: #2a2020;
        }

        .menu-btn.danger:hover {
            border-color: #6a4040;
            background: #3a2525;
        }

        .menu-btn.danger h3 {
            color: #c75b5b;
        }

        /* Stats Page */
        .stats-container {
            background: #202020;
            border: 1px solid #2a2a2a;
            padding: 30px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: #252525;
            border: 1px solid #333;
            padding: 20px;
            text-align: center;
        }

        .stat-card .value {
            font-size: 36px;
            font-weight: 300;
            color: #fff;
            margin-bottom: 8px;
        }

        .stat-card .label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .stat-card.positive .value {
            color: #5bc75b;
        }

        .stat-card.negative .value {
            color: #c75b5b;
        }

        .history-section {
            margin-top: 30px;
        }

        .history-section h3 {
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid #333;
        }

        .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: #252525;
            border: 1px solid #333;
            margin-bottom: 8px;
            font-size: 13px;
        }

        .history-item .result {
            font-weight: 500;
        }

        .history-item .result.win {
            color: #5bc75b;
        }

        .history-item .result.loss {
            color: #c75b5b;
        }

        .history-item .result.draw {
            color: #c7b55b;
        }

        .history-item .score {
            color: #666;
        }

        .history-item .points {
            color: #a09070;
        }

        /* Formation Screen */
        .formation-area {
            background: #202020;
            border: 1px solid #2a2a2a;
            padding: 30px;
            margin-bottom: 20px;
        }

        .formation-slots {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        .formation-slot {
            background: #252525;
            border: 2px solid #333;
            padding: 20px;
            text-align: center;
            cursor: move;
            min-height: 100px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            transition: all 0.2s;
        }

        .formation-slot:hover {
            border-color: #555;
        }

        .formation-slot .position-number {
            font-size: 24px;
            font-weight: 300;
            color: #444;
            margin-bottom: 8px;
        }

        .formation-slot.filled .position-number {
            color: #666;
        }

        .formation-slot .name {
            font-size: 13px;
            color: #fff;
            margin-bottom: 6px;
        }

        .formation-slot .stats {
            font-size: 11px;
            color: #666;
        }

        .formation-slot.dragging {
            opacity: 0.5;
            border-color: #555;
        }

        .formation-slot.drag-over {
            border-color: #888;
            background: #2a2a2a;
        }

        .formation-hint {
            text-align: center;
            font-size: 12px;
            color: #555;
            font-style: italic;
        }

        /* Scouting */
        .scout-panel {
            background: #202020;
            border: 1px solid #333;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
        }

        .scout-status {
            font-size: 13px;
            color: #888;
            margin-bottom: 12px;
        }

        .scout-btn {
            background: #2a2a30;
            border: 1px solid #4a4a5a;
            color: #888;
            padding: 10px 24px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .scout-btn:hover:not(:disabled) {
            border-color: #6a6a7a;
            color: #fff;
        }

        .scout-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .scouted-info {
            margin-top: 16px;
            padding: 16px;
            background: #252525;
            border-left: 3px solid #5b7bc7;
            text-align: left;
        }

        .scouted-info h4 {
            font-size: 13px;
            color: #fff;
            margin-bottom: 8px;
        }

        .scouted-info .stat-row {
            display: flex;
            gap: 16px;
            font-size: 12px;
            color: #888;
        }

        /* Training Camp - Expanded */
        .training-categories {
            margin-bottom: 30px;
        }

        .training-category {
            margin-bottom: 30px;
        }

        .training-category h4 {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 16px;
            padding-bottom: 8px;
            border-bottom: 1px solid #333;
        }

        .training-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
        }

        .training-option {
            background: #252525;
            border: 1px solid #333;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .training-option:hover:not(.disabled) {
            border-color: #555;
            background: #2a2a2a;
        }

        .training-option.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .training-option h4 {
            font-size: 13px;
            color: #fff;
            margin-bottom: 8px;
            text-transform: uppercase;
        }

        .training-option p {
            font-size: 12px;
            color: #666;
            margin-bottom: 12px;
            line-height: 1.4;
        }

        .training-option .cost {
            font-size: 11px;
            color: #a09070;
        }

        .training-option .risk {
            font-size: 10px;
            color: #c75b5b;
            margin-top: 4px;
        }

        /* Training Result Modal */
        .train-result {
            text-align: center;
            padding: 20px;
        }

        .train-result.success {
            background: #202a20;
            border: 1px solid #3a4a3a;
            color: #5bc75b;
        }

        .train-result.failure {
            background: #2a2020;
            border: 1px solid #4a3a3a;
            color: #c75b5b;
        }

        /* Identity Selection */
        .identity-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            margin-top: 30px;
        }

        .identity-btn {
            background: #252525;
            border: 1px solid #333;
            padding: 30px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .identity-btn:hover {
            background: #2a2a2a;
            border-color: #555;
        }

        .identity-btn.attack:hover { border-color: #c75b5b; }
        .identity-btn.defense:hover { border-color: #5b7bc7; }
        .identity-btn.positional:hover { border-color: #5bc78e; }

        .identity-btn h3 {
            font-size: 14px;
            font-weight: 500;
            letter-spacing: 1px;
            margin-bottom: 8px;
            text-transform: uppercase;
        }

        .identity-btn.attack h3 { color: #c75b5b; }
        .identity-btn.defense h3 { color: #5b7bc7; }
        .identity-btn.positional h3 { color: #5bc78e; }

        .identity-btn p {
            font-size: 13px;
            color: #777;
        }

        /* Draft Screen */
        .draft-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #333;
        }

        .identity-tag {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #666;
        }

        .identity-tag span {
            color: #fff;
            font-weight: 500;
        }

        .team-counter {
            font-size: 14px;
            color: #666;
        }

        .team-counter strong {
            color: #fff;
            font-weight: 500;
        }

        .current-team {
            background: #202020;
            border: 1px solid #2a2a2a;
            padding: 20px;
            margin-bottom: 30px;
        }

        .current-team h3 {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #666;
            margin-bottom: 16px;
        }

        .team-slots {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
        }

        .team-slot {
            background: #252525;
            border: 1px solid #333;
            padding: 16px;
            text-align: center;
            min-height: 80px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .team-slot.filled {
            border-color: #444;
        }

        .team-slot .name {
            font-size: 13px;
            color: #fff;
            margin-bottom: 6px;
        }

        .team-slot .stats {
            font-size: 11px;
            color: #666;
        }

        .team-slot.empty {
            color: #444;
            font-size: 12px;
        }

        .selection-area {
            background: #202020;
            border: 1px solid #2a2a2a;
            padding: 30px;
        }

        .selection-title {
            text-align: center;
            font-size: 14px;
            color: #888;
            margin-bottom: 24px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .player-options {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
        }

        .player-card {
            background: #252525;
            border: 1px solid #333;
            padding: 20px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .player-card:hover {
            border-color: #555;
            background: #2a2a2a;
        }

        .player-card h4 {
            font-size: 15px;
            font-weight: 400;
            color: #fff;
            margin-bottom: 16px;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            font-size: 12px;
        }

        .stat-row:last-child {
            margin-bottom: 0;
        }

        .stat-label {
            color: #666;
            text-transform: uppercase;
            font-size: 11px;
            letter-spacing: 0.5px;
        }

        .stat-value {
            color: #999;
            font-weight: 500;
        }

        .stat-value.high {
            color: #fff;
        }

        .stat-value.capped {
            color: #c7b55b;
        }

        /* Squad View */
        .squad-display {
            background: #202020;
            border: 1px solid #2a2a2a;
            padding: 30px;
            margin-bottom: 20px;
        }

        .squad-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid #333;
        }

        .squad-title {
            font-size: 16px;
            font-weight: 400;
            color: #fff;
        }

        .wins-until-unlock {
            font-size: 12px;
            color: #888;
        }

        .wins-until-unlock span {
            color: #5bc75b;
            font-weight: 500;
        }

        .swap-tokens {
            font-size: 12px;
            color: #a09070;
        }

        .player-detail {
            background: #252525;
            border: 1px solid #333;
            padding: 20px;
            margin-bottom: 12px;
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr;
            gap: 20px;
            align-items: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .player-detail:hover {
            border-color: #555;
            background: #2a2a2a;
        }

        .player-detail.swappable {
            border-color: #4a4030;
            background: #2a2520;
        }

        .player-detail.swappable:hover {
            border-color: #6a6050;
            background: #3a3530;
        }

        .player-detail.locked {
            opacity: 0.7;
            cursor: default;
        }

        .player-detail.locked:hover {
            border-color: #333;
            background: #252525;
        }

        .player-detail .name {
            font-size: 14px;
            color: #fff;
        }

        .player-detail .stat {
            text-align: center;
            font-size: 13px;
        }

        .player-detail .stat-label {
            display: block;
            font-size: 10px;
            color: #555;
            margin-bottom: 4px;
            text-transform: uppercase;
        }

        .player-detail .stat-value {
            color: #999;
        }

        .swap-hint {
            text-align: center;
            font-size: 12px;
            color: #a09070;
            margin-bottom: 20px;
            font-style: italic;
        }

        .back-btn {
            background: transparent;
            border: 1px solid #444;
            color: #888;
            padding: 12px 24px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .back-btn:hover {
            border-color: #666;
            color: #fff;
        }

        /* Match Screen */
        .match-setup {
            background: #202020;
            border: 1px solid #2a2a2a;
            padding: 30px;
        }

        .boards-container {
            margin-bottom: 30px;
        }

        .board {
            background: #252525;
            border: 1px solid #333;
            padding: 20px;
            margin-bottom: 12px;
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 20px;
            align-items: center;
        }

        .board-player {
            text-align: center;
        }

        .board-player.user {
            text-align: right;
        }

        .board-player.opponent {
            text-align: left;
        }

        .board-player .name {
            font-size: 13px;
            color: #fff;
            margin-bottom: 8px;
        }

        .board-player .position {
            font-size: 11px;
            color: #555;
            margin-bottom: 4px;
        }

        .attribute-select {
            background: #1a1a1a;
            border: 1px solid #444;
            color: #fff;
            padding: 8px 16px;
            font-size: 13px;
            cursor: pointer;
            min-width: 140px;
        }

        .attribute-select:focus {
            outline: none;
            border-color: #666;
        }

        .board-vs {
            text-align: center;
            color: #555;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .opponent-hidden {
            font-size: 12px;
            color: #444;
            font-style: italic;
        }

        .ai-attribute {
            font-size: 12px;
            color: #666;
            margin-top: 8px;
            min-height: 20px;
        }

        .ai-attribute.revealed {
            color: #c75b5b;
        }

        .board-result {
            text-align: center;
            font-size: 12px;
            font-weight: 500;
            min-height: 20px;
            grid-column: 1 / -1;
            margin-top: 8px;
            padding-top: 12px;
            border-top: 1px solid #333;
        }

        .board-result.win { color: #5bc75b; }
        .board-result.loss { color: #c75b5b; }
        .board-result.draw { color: #c7b55b; }

        .resolve-btn {
            display: block;
            width: 100%;
            background: #333;
            color: #fff;
            border: none;
            padding: 16px;
            font-size: 14px;
            cursor: pointer;
            transition: background 0.2s;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .resolve-btn:hover {
            background: #444;
        }

        .resolve-btn:disabled {
            background: #252525;
            color: #555;
            cursor: not-allowed;
        }

        .match-result {
            text-align: center;
            padding: 40px;
            background: #252525;
            border: 1px solid #333;
            margin-top: 30px;
        }

        .final-score {
            font-size: 48px;
            font-weight: 300;
            color: #fff;
            margin-bottom: 16px;
        }

        .result-text {
            font-size: 16px;
            color: #888;
        }

        .promotion-notice {
            margin-top: 20px;
            padding: 16px;
            background: #202a20;
            border: 1px solid #3a4a3a;
            font-size: 13px;
            color: #7a9a7a;
        }

        .demotion-notice {
            margin-top: 20px;
            padding: 16px;
            background: #2a2020;
            border: 1px solid #4a3a3a;
            font-size: 13px;
            color: #9a7a7a;
        }

        .league-promotion {
            margin-top: 20px;
            padding: 20px;
            background: #2a2a30;
            border: 1px solid #4a4a5a;
            font-size: 14px;
            color: #fff;
        }

        .season-end {
            margin-top: 20px;
            padding: 20px;
            background: #2a202a;
            border: 1px solid #4a3a4a;
            font-size: 14px;
            color: #fff;
        }

        /* Tutorial */
        .tutorial-content {
            background: #202020;
            border: 1px solid #2a2a2a;
            padding: 30px;
            max-width: 700px;
            margin: 0 auto;
        }

        .tutorial-content h3 {
            font-size: 14px;
            color: #fff;
            margin: 24px 0 12px 0;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .tutorial-content h3:first-child {
            margin-top: 0;
        }

        .tutorial-content p {
            font-size: 13px;
            color: #888;
            margin-bottom: 12px;
            line-height: 1.8;
        }

        .tutorial-content ul {
            margin-left: 20px;
            color: #888;
            font-size: 13px;
        }

        .tutorial-content li {
            margin-bottom: 8px;
            line-height: 1.6;
        }

        .league-list {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin: 16px 0;
        }

        .league-item {
            font-size: 12px;
            padding: 8px 12px;
            background: #252525;
            border: 1px solid #333;
            color: #777;
        }

        .league-item.current {
            border-color: #555;
            color: #fff;
        }

        /* Confirm Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.85);
            z-index: 100;
            justify-content: center;
            align-items: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: #202020;
            border: 1px solid #333;
            padding: 40px;
            max-width: 400px;
            text-align: center;
        }

        .modal-content h3 {
            color: #c75b5b;
            margin-bottom: 16px;
        }

        .modal-content p {
            color: #888;
            font-size: 13px;
            margin-bottom: 24px;
            line-height: 1.6;
        }

        .modal-buttons {
            display: flex;
            gap: 12px;
            justify-content: center;
        }

        /* Swap Modal */
        .swap-modal-content {
            background: #202020;
            border: 1px solid #333;
            padding: 30px;
            max-width: 600px;
            width: 90%;
        }

        .swap-modal-content h3 {
            color: #a09070;
            margin-bottom: 20px;
            text-align: center;
        }

        .swap-instruction {
            text-align: center;
            font-size: 13px;
            color: #888;
            margin-bottom: 20px;
        }

        .current-player {
            background: #2a2520;
            border: 1px solid #4a4030;
            padding: 16px;
            margin-bottom: 20px;
            text-align: center;
        }

        .current-player h4 {
            color: #a09070;
            margin-bottom: 8px;
        }

        .current-player .stats {
            color: #888;
            font-size: 13px;
        }

        @media (max-width: 768px) {
            .menu-grid,
            .training-grid,
            .identity-grid,
            .player-options,
            .team-slots,
            .formation-slots,
            .stats-grid,
            .league-list {
                grid-template-columns: 1fr;
            }
            
            .player-detail {
                grid-template-columns: 1fr;
                gap: 12px;
            }
            
            .board {
                grid-template-columns: 1fr;
                gap: 12px;
            }
            
            .board-player.user,
            .board-player.opponent {
                text-align: center;
            }
            
            .header-stats {
                flex-direction: column;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Fantasy Pawns League</h1>

        <!-- Menu Screen -->
        <div id="menu-screen" class="screen active">
            <div class="header-stats">
                <div>Points: <span id="points-display">0</span></div>
                <div>Scout Tokens: <span id="tokens-display">0</span></div>
                <div>Record: <span id="wins">0</span>W - <span id="draws">0</span>D - <span id="losses">0</span>L</div>
            </div>
            
            <div class="league-badge">
                <div class="league-name" id="current-league">Pawns League</div>
                <div class="league-record">
                    Squad Wins: <span id="squad-wins">0</span>/5 | Season: <span id="season-matches">0</span>/10
                </div>
                <div class="season-warning" id="season-warning" style="display: none;">
                    Season ending soon! You must redraft after 10 matches.
                </div>
            </div>
            
            <div class="menu-grid">
                <div class="menu-btn" onclick="startMatchFlow()">
                    <h3>Start Match</h3>
                    <p>Enter competition</p>
                </div>
                <div class="menu-btn" onclick="viewSquad()">
                    <h3>View Squad</h3>
                    <p>Check your team</p>
                </div>
                <div class="menu-btn" onclick="showTrainingCamp()">
                    <h3>Training Camp</h3>
                    <p>Spend points</p>
                </div>
                <div class="menu-btn" onclick="showStats()">
                    <h3>Stats</h3>
                    <p>Your career</p>
                </div>
                <div class="menu-btn" onclick="showTutorial()">
                    <h3>Tutorial</h3>
                    <p>How to play</p>
                </div>
                <div class="menu-btn danger" onclick="confirmResign()">
                    <h3>Resign</h3>
                    <p>Reset all progress</p>
                </div>
            </div>
        </div>

        <!-- Confirm Resign Modal -->
        <div id="resign-modal" class="modal-overlay">
            <div class="modal-content">
                <h3>Resign from League?</h3>
                <p>This will permanently delete your squad, points, league progress, and all history. This cannot be undone.</p>
                <div class="modal-buttons">
                    <button class="back-btn" onclick="closeResignModal()">Cancel</button>
                    <button class="back-btn" style="border-color: #6a4040; color: #c75b5b;" onclick="executeResign()">Confirm Resign</button>
                </div>
            </div>
        </div>

        <!-- Stats Screen -->
        <div id="stats-screen" class="screen">
            <h2 style="text-align: center; margin-bottom: 30px;">Career Statistics</h2>
            <div class="stats-container">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="value" id="stat-matches">0</div>
                        <div class="label">Matches Played</div>
                    </div>
                    <div class="stat-card positive">
                        <div class="value" id="stat-winrate">0%</div>
                        <div class="label">Win Rate</div>
                    </div>
                    <div class="stat-card">
                        <div class="value" id="stat-points">0</div>
                        <div class="label">Total Points Earned</div>
                    </div>
                    <div class="stat-card">
                        <div class="value" id="stat-avgmargin">0</div>
                        <div class="label">Avg Victory Margin</div>
                    </div>
                    <div class="stat-card positive">
                        <div class="value" id="stat-beststreak">0</div>
                        <div class="label">Best Win Streak</div>
                    </div>
                    <div class="stat-card">
                        <div class="value" id="stat-seasons">0</div>
                        <div class="label">Seasons Completed</div>
                    </div>
                </div>

                <div class="history-section">
                    <h3>Recent Match History</h3>
                    <div id="match-history"></div>
                </div>
            </div>
            <div style="text-align: center; margin-top: 30px;">
                <button class="back-btn" onclick="showScreen('menu-screen')">Back to Menu</button>
            </div>
        </div>

        <!-- Formation Screen -->
        <div id="formation-screen" class="screen">
            <h2 style="text-align: center;">Set Your Formation</h2>
            <p style="text-align: center; color: #666; margin-bottom: 30px;">Drag players to arrange match order (1 vs 1, 2 vs 2, etc.)</p>
            
            <div class="formation-area">
                <div class="formation-slots" id="formation-slots"></div>
                <div class="formation-hint">Your #1 will face opponent's #1, #2 vs #2, etc.</div>
            </div>

            <div class="scout-panel" id="scout-panel">
                <div class="scout-status" id="scout-status">Scout Tokens: 0</div>
                <button class="scout-btn" id="scout-btn" onclick="useScout()" disabled>
                    Scout Opponent (1 Token)
                </button>
                <div id="scouted-reveal"></div>
            </div>
            
            <div style="text-align: center; margin-top: 20px;">
                <button class="back-btn" onclick="showScreen('menu-screen')">Back</button>
                <button class="resolve-btn" style="display: inline-block; width: auto; margin-left: 12px;" onclick="confirmFormation()">Confirm Formation</button>
            </div>
        </div>

        <!-- Training Camp - Expanded -->
        <div id="training-screen" class="screen">
            <h2 style="text-align: center;">Training Camp</h2>
            <p style="text-align: center; color: #666; margin-bottom: 10px;">Available Points: <span id="training-points">0</span></p>
            <p style="text-align: center; color: #888; font-size: 12px; margin-bottom: 30px;">Training has failure chances. Higher stats = higher risk.</p>
            
            <div class="training-categories">
                <div class="training-category">
                    <h4>Individual Training</h4>
                    <div class="training-grid">
                        <div class="training-option" id="train-attack" onclick="trainSpecific('attack')">
                            <h4>Attack Training</h4>
                            <p>+1 Attack to one player</p>
                            <div class="cost">2 Points</div>
                            <div class="risk" id="risk-attack">Risk: Low</div>
                        </div>
                        <div class="training-option" id="train-defense" onclick="trainSpecific('defense')">
                            <h4>Defense Training</h4>
                            <p>+1 Defense to one player</p>
                            <div class="cost">2 Points</div>
                            <div class="risk" id="risk-defense">Risk: Low</div>
                        </div>
                        <div class="training-option" id="train-positional" onclick="trainSpecific('positional')">
                            <h4>Positional Training</h4>
                            <p>+1 Positional to one player</p>
                            <div class="cost">2 Points</div>
                            <div class="risk" id="risk-positional">Risk: Low</div>
                        </div>
                    </div>
                </div>

                <div class="training-category">
                    <h4>Elite Training (Higher Risk)</h4>
                    <div class="training-grid">
                        <div class="training-option" id="train-master" onclick="trainMaster()">
                            <h4>Master Class</h4>
                            <p>+1 to all stats of one player</p>
                            <div class="cost">5 Points</div>
                            <div class="risk">Risk: Very High</div>
                        </div>
                        <div class="training-option" id="train-specialist" onclick="trainSpecialist()">
                            <h4>Specialist</h4>
                            <p>+2 to one stat (max 15)</p>
                            <div class="cost">4 Points</div>
                            <div class="risk">Risk: High</div>
                        </div>
                        <div class="training-option" id="train-team" onclick="trainTeam()">
                            <h4>Team Building</h4>
                            <p>+1 to same stat for all 4 players</p>
                            <div class="cost">6 Points</div>
                            <div class="risk">Risk: High</div>
                        </div>
                    </div>
                </div>

                <div class="training-category">
                    <h4>Support</h4>
                    <div class="training-grid">
                        <div class="training-option" id="train-scout" onclick="buyScout()">
                            <h4>Scout Training</h4>
                            <p>Gain 2 scout tokens</p>
                            <div class="cost">3 Points</div>
                        </div>
                        <div class="training-option" id="train-intel" onclick="buyIntel()">
                            <h4>Advanced Intel</h4>
                            <p>Reveal full opponent formation next match</p>
                            <div class="cost">4 Points</div>
                        </div>
                        <div class="training-option" id="train-morale" onclick="boostMorale()">
                            <h4>Morale Boost</h4>
                            <p>Next match: +1 to all chosen attributes</p>
                            <div class="cost">3 Points</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div style="text-align: center; margin-top: 30px;">
                <button class="back-btn" onclick="showScreen('menu-screen')">Back to Menu</button>
            </div>
        </div>

        <!-- Training Result Modal -->
        <div id="train-result-modal" class="modal-overlay">
            <div class="modal-content" style="max-width: 350px;">
                <div id="train-result-content"></div>
                <button class="back-btn" onclick="closeTrainResult()" style="margin-top: 20px;">Continue</button>
            </div>
        </div>

        <!-- Training Modals -->
        <div id="train-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 100; justify-content: center; align-items: center;">
            <div style="background: #202020; border: 1px solid #333; padding: 30px; max-width: 500px; width: 90%;">
                <h3 style="margin-bottom: 20px;" id="train-modal-title">Select Player</h3>
                <div id="train-players"></div>
                <div style="text-align: center; margin-top: 20px;">
                    <button class="back-btn" onclick="closeTrainModal()">Cancel</button>
                </div>
            </div>
        </div>

        <!-- Swap Modal -->
        <div id="swap-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 100; justify-content: center; align-items: center;">
            <div class="swap-modal-content">
                <h3>Swap Player</h3>
                <div class="swap-instruction">Choose a replacement from 3 random options</div>
                
                <div class="current-player" id="swap-current-player">
                    <h4>Current Player</h4>
                    <div class="stats" id="swap-current-stats"></div>
                </div>
                
                <div class="selection-title" style="margin-bottom: 16px;">Select Replacement</div>
                <div class="player-options" id="swap-options"></div>
                
                <div style="text-align: center; margin-top: 20px;">
                    <button class="back-btn" onclick="closeSwapModal()">Cancel</button>
                </div>
            </div>
        </div>

        <!-- Draft Screens -->
        <div id="start-screen" class="screen">
            <div class="squad-lock" id="squad-lock-msg" style="display: none; background: #2a2520; border: 1px solid #4a4030; padding: 16px; margin-bottom: 20px; text-align: center; font-size: 13px; color: #a09070;">
                Your squad is locked. Win <span id="wins-needed">5</span> more matches to unlock.
            </div>
            <h2 style="text-align: center;">Select Your Identity</h2>
            <div class="identity-grid">
                <div class="identity-btn attack" onclick="selectIdentity('Attack')">
                    <h3>Attack</h3>
                    <p>Offensive dominance</p>
                </div>
                <div class="identity-btn defense" onclick="selectIdentity('Defense')">
                    <h3>Defense</h3>
                    <p>Solid resilience</p>
                </div>
                <div class="identity-btn positional" onclick="selectIdentity('Positional')">
                    <h3>Positional</h3>
                    <p>Strategic precision</p>
                </div>
            </div>
            <div style="text-align: center; margin-top: 30px;">
                <button class="back-btn" onclick="showScreen('menu-screen')">Back to Menu</button>
            </div>
        </div>

        <div id="draft-screen" class="screen">
            <div class="draft-header">
                <div class="identity-tag">Identity: <span id="current-identity"></span></div>
                <div class="team-counter">Team: <strong id="team-count">0</strong>/4</div>
            </div>

            <div class="current-team">
                <h3>Current Roster</h3>
                <div class="team-slots" id="team-slots"></div>
            </div>

            <div class="selection-area">
                <div class="selection-title" id="selection-title"></div>
                <div class="player-options" id="player-options"></div>
            </div>
        </div>

        <!-- Squad View -->
        <div id="squad-screen" class="screen">
            <div class="squad-display">
                <div class="squad-header">
                    <div class="squad-title">Your Squad</div>
                    <div class="wins-until-unlock" id="unlock-status">
                        Wins until unlock: <span id="unlock-wins">5</span>
                    </div>
                    <div class="swap-tokens" id="swap-tokens-display" style="display: none;">
                        Swap Tokens: <span id="swap-tokens">2</span>
                    </div>
                </div>
                <div class="swap-hint" id="swap-hint" style="display: none;">
                    Click a player to swap them with a new draft pick
                </div>
                <div id="squad-list"></div>
            </div>
            <div style="text-align: center;">
                <button class="back-btn" onclick="showScreen('menu-screen')">Back to Menu</button>
            </div>
        </div>

        <!-- Tutorial -->
        <div id="tutorial-screen" class="screen">
            <div class="tutorial-content">
                <h3>The Draft</h3>
                <p>Select an identity. Receive 2 core players with 8+ in that attribute, then draft 2 more.</p>
                
                <h3>Formation Tactics</h3>
                <p>Arrange your 4 players in order before each match. Your #1 faces their #1, etc. Scout to see opponent formation.</p>
                
                <h3>Seasons (10 Matches)</h3>
                <p>After 10 matches with a squad, you must redraft. Points and league progress carry over.</p>
                
                <h3>Dynamic Difficulty</h3>
                <p>AI scales with your stats. Higher leagues = stronger opponents. 15 is the absolute stat cap.</p>
                
                <h3>Training Risk</h3>
                <p>Higher stats = higher failure chance. Training above 10 is risky but rewarding.</p>
                
                <h3>Squad Swaps</h3>
                <p>After unlocking your squad (5 wins), you get 2 swap tokens to change players via the 1-of-3 draft method.</p>
                
                <h3>League Progression</h3>
                <div class="league-list" id="league-list"></div>
                
                <div style="text-align: center; margin-top: 30px;">
                    <button class="back-btn" onclick="showScreen('menu-screen')">Back to Menu</button>
                </div>
            </div>
        </div>

        <!-- Match Screen -->
        <div id="match-screen" class="screen">
            <h2 style="text-align: center; margin-bottom: 30px;">Match Setup</h2>
            <div class="match-setup">
                <div class="boards-container" id="boards-container"></div>
                <button class="resolve-btn" id="resolve-btn" onclick="enterMatch()" disabled>Enter Match</button>
            </div>
        </div>

        <!-- Match Result -->
        <div id="result-screen" class="screen">
            <div class="match-result" id="match-result-display">
                <div class="final-score" id="final-score"></div>
                <div class="result-text" id="result-text"></div>
                <div id="changes-display"></div>
                <div id="league-change-display"></div>
                <div id="season-end-display"></div>
                <button class="back-btn" onclick="returnToMenu()" style="margin-top: 30px;">Continue</button>
            </div>
        </div>
    </div>

    <script>
        const LEAGUES = [
            'Pawns League',
            'Bishops League',
            "Knight's League I",
            "Knight's League II",
            'Rooks League I',
            'Rooks League II',
            'Queens League I',
            'Queens League II',
            'Queens League III',
            'Kings League',
            'Kings Champions League'
        ];

        const STAT_CAP = 15;

        // Embedded player data (previously players.json)
        const playerPool = [
            {"name": "Magnus Carlsen", "attack": 9, "defense": 9, "positional": 10},
            {"name": "Garry Kasparov", "attack": 10, "defense": 7, "positional": 9},
            {"name": "Bobby Fischer", "attack": 10, "defense": 8, "positional": 9},
            {"name": "Anatoly Karpov", "attack": 7, "defense": 10, "positional": 10},
            {"name": "Vladimir Kramnik", "attack": 7, "defense": 10, "positional": 9},
            {"name": "Viswanathan Anand", "attack": 8, "defense": 9, "positional": 9},
            {"name": "Ding Liren", "attack": 8, "defense": 9, "positional": 9},
            {"name": "Fabiano Caruana", "attack": 8, "defense": 9, "positional": 9},
            {"name": "Ian Nepomniachtchi", "attack": 9, "defense": 7, "positional": 8},
            {"name": "Hikaru Nakamura", "attack": 9, "defense": 8, "positional": 8},
            {"name": "Alireza Firouzja", "attack": 9, "defense": 7, "positional": 8},
            {"name": "Mikhail Tal", "attack": 10, "defense": 6, "positional": 7},
            {"name": "José Raúl Capablanca", "attack": 8, "defense": 9, "positional": 10},
            {"name": "Vasily Smyslov", "attack": 8, "defense": 9, "positional": 10},
            {"name": "Tigran Petrosian", "attack": 6, "defense": 10, "positional": 9},
            {"name": "Levon Aronian", "attack": 9, "defense": 7, "positional": 9},
            {"name": "Alexander Grischuk", "attack": 9, "defense": 7, "positional": 8},
            {"name": "Maxime Vachier-Lagrave", "attack": 9, "defense": 7, "positional": 8},
            {"name": "Shakhriyar Mamedyarov", "attack": 9, "defense": 7, "positional": 8},
            {"name": "Veselin Topalov", "attack": 9, "defense": 6, "positional": 8},
            {"name": "Richard Rapport", "attack": 9, "defense": 6, "positional": 8},
            {"name": "Judit Polgár", "attack": 9, "defense": 7, "positional": 8},
            {"name": "Wesley So", "attack": 7, "defense": 9, "positional": 9},
            {"name": "Sergey Karjakin", "attack": 7, "defense": 9, "positional": 8},
            {"name": "Anish Giri", "attack": 7, "defense": 9, "positional": 9},
            {"name": "Peter Leko", "attack": 7, "defense": 9, "positional": 8},
            {"name": "Boris Gelfand", "attack": 7, "defense": 9, "positional": 9},
            {"name": "Viktor Korchnoi", "attack": 8, "defense": 9, "positional": 8},
            {"name": "Paul Keres", "attack": 8, "defense": 8, "positional": 9},
            {"name": "Aron Nimzowitsch", "attack": 7, "defense": 8, "positional": 10},
            {"name": "Akiba Rubinstein", "attack": 7, "defense": 9, "positional": 10},
            {"name": "Miguel Najdorf", "attack": 8, "defense": 7, "positional": 8},
            {"name": "Samuel Reshevsky", "attack": 8, "defense": 8, "positional": 8},
            {"name": "Efim Geller", "attack": 8, "defense": 8, "positional": 9},
            {"name": "Ulf Andersson", "attack": 6, "defense": 9, "positional": 9},
            {"name": "Pentala Harikrishna", "attack": 7, "defense": 8, "positional": 8},
            {"name": "Jan-Krzysztof Duda", "attack": 8, "defense": 8, "positional": 8},
            {"name": "Teimour Radjabov", "attack": 7, "defense": 9, "positional": 8},
            {"name": "Gata Kamsky", "attack": 8, "defense": 8, "positional": 8},
            {"name": "Wei Yi", "attack": 9, "defense": 6, "positional": 8},
            {"name": "Gukesh Dommaraju", "attack": 9, "defense": 8, "positional": 8},
            {"name": "Arjun Erigaisi", "attack": 9, "defense": 7, "positional": 8},
            {"name": "R Praggnanandhaa", "attack": 8, "defense": 8, "positional": 8},
            {"name": "Nodirbek Abdusattorov", "attack": 8, "defense": 8, "positional": 8},
            {"name": "Hans Niemann", "attack": 8, "defense": 7, "positional": 7},
            {"name": "Vincent Keymer", "attack": 8, "defense": 8, "positional": 8},
            {"name": "Nihal Sarin", "attack": 8, "defense": 7, "positional": 8},
            {"name": "David Navara", "attack": 8, "defense": 8, "positional": 8},
            {"name": "Baadur Jobava", "attack": 9, "defense": 6, "positional": 7},
            {"name": "Hou Yifan", "attack": 8, "defense": 8, "positional": 9},
            {"name": "Humpy Koneru", "attack": 8, "defense": 8, "positional": 8},
            {"name": "Alexandra Kosteniuk", "attack": 8, "defense": 7, "positional": 8},
            {"name": "Valentina Gunina", "attack": 9, "defense": 6, "positional": 7},
            {"name": "Leinier Domínguez", "attack": 8, "defense": 8, "positional": 8},
            {"name": "Alexander Morozevich", "attack": 9, "defense": 6, "positional": 8},
            {"name": "Vladimir Ivanchuk", "attack": 9, "defense": 7, "positional": 9},
            {"name": "Boris Spassky", "attack": 8, "defense": 8, "positional": 9},
            {"name": "Wilhelm Steinitz", "attack": 7, "defense": 8, "positional": 9},
            {"name": "Emanuel Lasker", "attack": 8, "defense": 9, "positional": 9}
        ];

        let gameState = {
            identity: null,
            userTeam: [],
            aiTeam: [],
            formation: [0, 1, 2, 3],
            availablePlayers: [],
            draftStep: 0,
            matchups: [],
            wins: 0,
            draws: 0,
            losses: 0,
            points: 0,
            squadWins: 0,
            currentLeague: 0,
            squadLocked: false,
            scoutTokens: 0,
            matchesPlayed: 0,
            seasonMatches: 0,
            seasonsCompleted: 0,
            matchHistory: [],
            totalPointsEarned: 0,
            currentStreak: 0,
            bestStreak: 0,
            moraleBoost: false,
            fullIntel: false,
            swapTokens: 0,
            swappedPlayers: []
        };

        let currentSwapIndex = null;

        function init() {
            loadGameState();
            updateMenuDisplay();
        }

        function loadGameState() {
            const saved = localStorage.getItem('fpl_save_v7');
            if (saved) {
                const data = JSON.parse(saved);
                Object.assign(gameState, data);
                if (!gameState.formation || gameState.formation.length !== 4) {
                    gameState.formation = [0, 1, 2, 3];
                }
                if (gameState.draws === undefined) gameState.draws = 0;
                if (!gameState.matchHistory) gameState.matchHistory = [];
                if (gameState.totalPointsEarned === undefined) gameState.totalPointsEarned = 0;
                if (gameState.currentStreak === undefined) gameState.currentStreak = 0;
                if (gameState.bestStreak === undefined) gameState.bestStreak = 0;
                if (gameState.moraleBoost === undefined) gameState.moraleBoost = false;
                if (gameState.fullIntel === undefined) gameState.fullIntel = false;
                if (gameState.seasonMatches === undefined) gameState.seasonMatches = 0;
                if (gameState.seasonsCompleted === undefined) gameState.seasonsCompleted = 0;
                if (gameState.swapTokens === undefined) gameState.swapTokens = 0;
                if (gameState.swappedPlayers === undefined) gameState.swappedPlayers = [];
            }
        }

        function saveGameState() {
            const data = {...gameState};
            localStorage.setItem('fpl_save_v7', JSON.stringify(data));
        }

        function updateMenuDisplay() {
            document.getElementById('current-league').textContent = LEAGUES[gameState.currentLeague];
            document.getElementById('wins').textContent = gameState.wins;
            document.getElementById('draws').textContent = gameState.draws;
            document.getElementById('losses').textContent = gameState.losses;
            document.getElementById('points-display').textContent = gameState.points;
            document.getElementById('tokens-display').textContent = gameState.scoutTokens;
            document.getElementById('squad-wins').textContent = gameState.squadWins;
            document.getElementById('season-matches').textContent = gameState.seasonMatches;
            
            // Show season warning
            if (gameState.seasonMatches >= 8) {
                document.getElementById('season-warning').style.display = 'block';
                document.getElementById('season-warning').textContent = 
                    `Season ending in ${10 - gameState.seasonMatches} matches! You must redraft soon.`;
            } else {
                document.getElementById('season-warning').style.display = 'none';
            }
        }

        // Calculate AI difficulty based on user team stats and league
        function getAIDifficulty() {
            // Calculate average user stat
            let totalStats = 0;
            let statCount = 0;
            gameState.userTeam.forEach(p => {
                totalStats += p.attack + p.defense + p.positional;
                statCount += 3;
            });
            const avgUserStat = totalStats / statCount;
            
            // Base difficulty from league - reduced scaling
            const leagueBonus = gameState.currentLeague * 0.3;
            
            // Dynamic scaling: AI averages around user average + league bonus
            // But with variance so some are stronger, some weaker
            const targetAvg = Math.min(11, avgUserStat + leagueBonus - 0.5); // Slightly easier
            
            return {
                targetAvg: targetAvg,
                variance: 1.5 + (gameState.currentLeague * 0.2), // Reduced variance
                minStat: Math.max(4, Math.floor(targetAvg - 1.5)),
                maxStat: Math.min(STAT_CAP, Math.ceil(targetAvg + 2))
            };
        }

        // Stats functions
        function showStats() {
            showScreen('stats-screen');
            
            const totalMatches = gameState.wins + gameState.draws + gameState.losses;
            const winRate = totalMatches > 0 ? Math.round((gameState.wins / totalMatches) * 100) : 0;
            
            let totalMargin = 0;
            let winsWithMargin = 0;
            gameState.matchHistory.forEach(match => {
                if (match.result === 'win') {
                    totalMargin += match.margin;
                    winsWithMargin++;
                }
            });
            const avgMargin = winsWithMargin > 0 ? (totalMargin / winsWithMargin).toFixed(1) : '0.0';
            
            document.getElementById('stat-matches').textContent = totalMatches;
            document.getElementById('stat-winrate').textContent = winRate + '%';
            document.getElementById('stat-points').textContent = gameState.totalPointsEarned;
            document.getElementById('stat-avgmargin').textContent = avgMargin;
            document.getElementById('stat-beststreak').textContent = gameState.bestStreak;
            document.getElementById('stat-seasons').textContent = gameState.seasonsCompleted;
            
            const historyContainer = document.getElementById('match-history');
            historyContainer.innerHTML = '';
            
            const recentMatches = gameState.matchHistory.slice(-10).reverse();
            
            if (recentMatches.length === 0) {
                historyContainer.innerHTML = '<div style="text-align: center; color: #555; padding: 20px;">No matches played yet</div>';
            } else {
                recentMatches.forEach(match => {
                    const div = document.createElement('div');
                    div.className = 'history-item';
                    
                    const resultClass = match.result;
                    const resultText = match.result === 'win' ? 'WIN' : match.result === 'loss' ? 'LOSS' : 'DRAW';
                    
                    div.innerHTML = `
                        <span class="result ${resultClass}">${resultText}</span>
                        <span class="score">${match.score}</span>
                        <span class="points">+${match.points} pts</span>
                    `;
                    
                    historyContainer.appendChild(div);
                });
            }
        }

        // Resign functions
        function confirmResign() {
            document.getElementById('resign-modal').classList.add('active');
        }

        function closeResignModal() {
            document.getElementById('resign-modal').classList.remove('active');
        }

        function executeResign() {
            localStorage.removeItem('fpl_save_v7');
            gameState = {
                identity: null,
                userTeam: [],
                aiTeam: [],
                formation: [0, 1, 2, 3],
                availablePlayers: [],
                draftStep: 0,
                matchups: [],
                wins: 0,
                draws: 0,
                losses: 0,
                points: 0,
                squadWins: 0,
                currentLeague: 0,
                squadLocked: false,
                scoutTokens: 0,
                matchesPlayed: 0,
                seasonMatches: 0,
                seasonsCompleted: 0,
                matchHistory: [],
                totalPointsEarned: 0,
                currentStreak: 0,
                bestStreak: 0,
                moraleBoost: false,
                fullIntel: false,
                swapTokens: 0,
                swappedPlayers: []
            };
            closeResignModal();
            updateMenuDisplay();
            showScreen('menu-screen');
        }

        function startMatchFlow() {
            // Check if season ended
            if (gameState.seasonMatches >= 10 && gameState.userTeam.length === 4) {
                alert('Season ended! You must redraft your squad.');
                resetSquad();
                return;
            }
            
            if (gameState.userTeam.length === 4 && gameState.squadLocked) {
                showFormationScreen();
            } else if (gameState.userTeam.length === 4 && !gameState.squadLocked) {
                gameState.squadLocked = true;
                gameState.squadWins = 0;
                saveGameState();
                showFormationScreen();
            } else {
                showScreen('start-screen');
                if (gameState.squadLocked) {
                    document.getElementById('squad-lock-msg').style.display = 'block';
                    document.getElementById('wins-needed').textContent = 5 - gameState.squadWins;
                }
            }
        }

        function resetSquad() {
            gameState.userTeam = [];
            gameState.squadLocked = false;
            gameState.squadWins = 0;
            gameState.seasonMatches = 0;
            gameState.seasonsCompleted++;
            gameState.formation = [0, 1, 2, 3];
            gameState.swapTokens = 0;
            gameState.swappedPlayers = [];
            saveGameState();
            showScreen('start-screen');
        }

        function showFormationScreen() {
            showScreen('formation-screen');
            
            const container = document.getElementById('formation-slots');
            container.innerHTML = '';
            
            gameState.formation.forEach((teamIdx, position) => {
                const player = gameState.userTeam[teamIdx];
                const div = document.createElement('div');
                div.className = 'formation-slot filled';
                div.draggable = true;
                div.dataset.position = position;
                div.dataset.teamIdx = teamIdx;
                
                div.innerHTML = `
                    <div class="position-number">${position + 1}</div>
                    <div class="name">${player.name}</div>
                    <div class="stats">A:${player.attack} D:${player.defense} P:${player.positional}</div>
                `;
                
                div.addEventListener('dragstart', handleDragStart);
                div.addEventListener('dragover', handleDragOver);
                div.addEventListener('drop', handleDrop);
                div.addEventListener('dragend', handleDragEnd);
                
                container.appendChild(div);
            });
            
            document.getElementById('scout-status').textContent = `Scout Tokens: ${gameState.scoutTokens}`;
            document.getElementById('scout-btn').disabled = gameState.scoutTokens < 1;
            document.getElementById('scouted-reveal').innerHTML = '';
            
            if (gameState.fullIntel) {
                const intelDiv = document.createElement('div');
                intelDiv.className = 'scouted-info';
                intelDiv.style.borderLeftColor = '#5bc75b';
                intelDiv.innerHTML = '<h4>Advanced Intel Active</h4>';
                
                gameState.aiTeam.forEach((p, idx) => {
                    const pos = gameState.aiFormation.indexOf(idx) + 1;
                    intelDiv.innerHTML += `
                        <div class="stat-row" style="margin-bottom: 4px;">
                            <span>Pos ${pos}: ${p.name}</span>
                            <span>A:${p.attack} D:${p.defense} P:${p.positional}</span>
                        </div>
                    `;
                });
                
                document.getElementById('scouted-reveal').appendChild(intelDiv);
                gameState.fullIntel = false;
                saveGameState();
            }
            
            generateAITeam();
            gameState.aiFormation = shuffle([0, 1, 2, 3]);
        }

        let draggedElement = null;

        function handleDragStart(e) {
            draggedElement = this;
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            this.classList.add('drag-over');
        }

        function handleDrop(e) {
            e.preventDefault();
            this.classList.remove('drag-over');
            
            if (draggedElement === this) return;
            
            const fromPos = parseInt(draggedElement.dataset.position);
            const toPos = parseInt(this.dataset.position);
            
            const temp = gameState.formation[fromPos];
            gameState.formation[fromPos] = gameState.formation[toPos];
            gameState.formation[toPos] = temp;
            
            saveGameState();
            showFormationScreen();
        }

        function handleDragEnd(e) {
            this.classList.remove('dragging');
            document.querySelectorAll('.formation-slot').forEach(slot => {
                slot.classList.remove('drag-over');
            });
        }

        function useScout() {
            if (gameState.scoutTokens < 1) return;
            
            gameState.scoutTokens--;
            saveGameState();
            
            document.getElementById('scout-status').textContent = `Scout Tokens: ${gameState.scoutTokens}`;
            document.getElementById('scout-btn').disabled = gameState.scoutTokens < 1;
            
            const revealIdx = Math.floor(Math.random() * 4);
            const opponent = gameState.aiTeam[gameState.aiFormation[revealIdx]];
            
            const div = document.createElement('div');
            div.className = 'scouted-info';
            div.innerHTML = `
                <h4>Scouted: Position ${revealIdx + 1}</h4>
                <div class="stat-row">
                    <span>${opponent.name}</span>
                    <span>A:${opponent.attack}</span>
                    <span>D:${opponent.defense}</span>
                    <span>P:${opponent.positional}</span>
                </div>
            `;
            
            document.getElementById('scouted-reveal').appendChild(div);
        }

        function confirmFormation() {
            showScreen('match-screen');
            setupMatchBoards();
        }

        function setupMatchBoards() {
            const container = document.getElementById('boards-container');
            container.innerHTML = '';
            gameState.matchups = [];
            
            for (let i = 0; i < 4; i++) {
                const userIdx = gameState.formation[i];
                const aiIdx = gameState.aiFormation[i];
                const userPlayer = gameState.userTeam[userIdx];
                const aiPlayer = gameState.aiTeam[aiIdx];
                
                let userValDisplay = userPlayer.attack;
                if (gameState.moraleBoost) userValDisplay += 1;
                
                const board = document.createElement('div');
                board.className = 'board';
                board.innerHTML = `
                    <div class="board-player user">
                        <div class="position">Your #${i + 1}</div>
                        <div class="name">${userPlayer.name}</div>
                        <select class="attribute-select" id="user-attr-${i}" onchange="checkAllSelected()">
                            <option value="">Select...</option>
                            <option value="attack">Attack (${userPlayer.attack}${gameState.moraleBoost ? '+1' : ''})</option>
                            <option value="defense">Defense (${userPlayer.defense}${gameState.moraleBoost ? '+1' : ''})</option>
                            <option value="positional">Positional (${userPlayer.positional}${gameState.moraleBoost ? '+1' : ''})</option>
                        </select>
                    </div>
                    <div class="board-vs">vs</div>
                    <div class="board-player opponent">
                        <div class="position">Opponent #${i + 1}</div>
                        <div class="name">${aiPlayer.name}</div>
                        <div class="opponent-hidden" id="opponent-status-${i}">???</div>
                    </div>
                `;
                container.appendChild(board);
                
                gameState.matchups.push({
                    user: userPlayer,
                    ai: aiPlayer,
                    userChoice: null,
                    aiChoice: null,
                    result: null
                });
            }
            
            document.getElementById('resolve-btn').disabled = true;
        }

        function checkAllSelected() {
            let allSelected = true;
            for (let i = 0; i < 4; i++) {
                if (!document.getElementById(`user-attr-${i}`).value) allSelected = false;
            }
                        document.getElementById('resolve-btn').disabled = !allSelected;
        }

        function enterMatch() {
            let userScore = 0;
            let aiScore = 0;
            
            for (let i = 0; i < 4; i++) {
                const matchup = gameState.matchups[i];
                const userAttr = document.getElementById(`user-attr-${i}`).value;
                let userVal = matchup.user[userAttr];
                if (gameState.moraleBoost) userVal += 1;
                
                const aiVal = matchup.ai[userAttr];
                
                const opponentStatus = document.getElementById(`opponent-status-${i}`);
                opponentStatus.textContent = `${userAttr} (${aiVal})`;
                opponentStatus.className = 'ai-attribute revealed';
                
                matchup.userChoice = { name: userAttr, val: userVal };
                matchup.aiChoice = { name: userAttr, val: aiVal };
                
                let result;
                if (userVal > aiVal) {
                    result = 'win';
                    userScore++;
                } else if (userVal < aiVal) {
                    result = 'loss';
                    aiScore++;
                } else {
                    result = 'draw';
                }
                matchup.result = result;
                
                const board = document.getElementById(`user-attr-${i}`).closest('.board');
                let resultDiv = board.querySelector('.board-result');
                if (!resultDiv) {
                    resultDiv = document.createElement('div');
                    resultDiv.className = 'board-result';
                    board.appendChild(resultDiv);
                }
                resultDiv.className = `board-result ${result}`;
                resultDiv.textContent = result.toUpperCase();
            }
            
            for (let i = 0; i < 4; i++) {
                document.getElementById(`user-attr-${i}`).disabled = true;
            }
            
            document.getElementById('resolve-btn').disabled = true;
            
            const margin = userScore - aiScore;
            const pointsEarned = Math.max(0, margin);
            
            const matchWon = userScore > aiScore;
            
            if (gameState.moraleBoost) {
                gameState.moraleBoost = false;
                saveGameState();
            }
            
            processMatchResult(matchWon, userScore, aiScore, pointsEarned);
        }

        function processMatchResult(won, userScore, aiScore, pointsEarned) {
            let promotionMsg = '';
            let seasonEnded = false;
            let justUnlocked = false;
            
            // Update streak
            if (won) {
                gameState.currentStreak = Math.max(1, gameState.currentStreak + 1);
                if (gameState.currentStreak > gameState.bestStreak) {
                    gameState.bestStreak = gameState.currentStreak;
                }
            } else if (userScore === aiScore) {
                gameState.currentStreak = 0;
            } else {
                gameState.currentStreak = Math.min(-1, gameState.currentStreak - 1);
            }
            
            // Record match history
            const matchResult = won ? 'win' : (userScore === aiScore ? 'draw' : 'loss');
            gameState.matchHistory.push({
                result: matchResult,
                score: `${userScore}-${aiScore}`,
                points: pointsEarned,
                margin: userScore - aiScore,
                date: new Date().toISOString()
            });
            
            if (gameState.matchHistory.length > 50) {
                gameState.matchHistory.shift();
            }
            
            // Increment season matches
            gameState.seasonMatches++;
            
            // Check season end
            if (gameState.seasonMatches >= 10) {
                seasonEnded = true;
            }
            
            if (won) {
                gameState.points += pointsEarned;
                gameState.totalPointsEarned += pointsEarned;
                
                let weakestPlayer = null;
                let weakestAttr = null;
                let lowestVal = 16;
                
                gameState.userTeam.forEach(p => {
                    ['attack', 'defense', 'positional'].forEach(attr => {
                        if (p[attr] < lowestVal) {
                            lowestVal = p[attr];
                            weakestPlayer = p;
                            weakestAttr = attr;
                        }
                    });
                });
                
                if (weakestPlayer && weakestAttr && weakestPlayer[weakestAttr] < STAT_CAP) {
                    weakestPlayer[weakestAttr]++;
                    promotionMsg = `${weakestPlayer.name} +1 ${weakestAttr}`;
                }
                
                gameState.wins++;
                gameState.squadWins++;
                gameState.matchesPlayed++;
                
                // Check if squad just unlocked (reached 5 wins)
                if (gameState.squadWins === 5 && gameState.squadLocked) {
                    justUnlocked = true;
                    gameState.swapTokens = 2; // Give 2 swap tokens
                }
                
                if (gameState.wins % 3 === 0 && gameState.currentLeague < LEAGUES.length - 1) {
                    gameState.currentLeague++;
                }
            } else if (userScore === aiScore) {
                gameState.draws++;
                gameState.matchesPlayed++;
            } else {
                gameState.losses++;
                gameState.matchesPlayed++;
            }
            
            if (gameState.squadWins >= 5) {
                gameState.squadLocked = false;
            }
            
            saveGameState();
            
            setTimeout(() => {
                showResults(won, userScore, aiScore, pointsEarned, promotionMsg, seasonEnded, justUnlocked);
            }, 1000);
        }

        function showResults(won, userScore, aiScore, pointsEarned, promotionMsg, seasonEnded, justUnlocked) {
            showScreen('result-screen');
            
            document.getElementById('final-score').innerHTML = 
                `<span style="color: #5b7bc7;">${userScore}</span> — <span style="color: #c75b5b;">${aiScore}</span>`;
            
            let resultText = won ? 'Victory' : (userScore === aiScore ? 'Draw' : 'Defeat');
            document.getElementById('result-text').textContent = resultText;
            
            const changesDiv = document.getElementById('changes-display');
            changesDiv.innerHTML = '';
            
            if (won && pointsEarned > 0) {
                const div = document.createElement('div');
                div.className = 'promotion-notice';
                div.innerHTML = `+${pointsEarned} Points${promotionMsg ? '<br>' + promotionMsg : ''}`;
                changesDiv.appendChild(div);
            }
            
            const leagueDiv = document.getElementById('league-change-display');
            leagueDiv.innerHTML = '';
            
            if (won && gameState.wins > 0 && (gameState.wins - 1) % 3 === 2 && (gameState.wins % 3 === 0)) {
                const div = document.createElement('div');
                div.className = 'league-promotion';
                div.innerHTML = `Promoted to <strong>${LEAGUES[gameState.currentLeague]}</strong>!`;
                leagueDiv.appendChild(div);
            }
            
            if (justUnlocked) {
                const div = document.createElement('div');
                div.className = 'promotion-notice';
                div.innerHTML = `<strong>Squad Unlocked!</strong><br>You have 2 swap tokens to change players. Visit Squad view to use them.`;
                leagueDiv.appendChild(div);
            } else if (gameState.squadWins >= 5 && !gameState.squadLocked && gameState.swapTokens > 0) {
                const div = document.createElement('div');
                div.className = 'promotion-notice';
                div.innerHTML = `Squad unlocked! You have ${gameState.swapTokens} swap token${gameState.swapTokens !== 1 ? 's' : ''} remaining.`;
                leagueDiv.appendChild(div);
            }
            
            const seasonDiv = document.getElementById('season-end-display');
            seasonDiv.innerHTML = '';
            
            if (seasonEnded) {
                const div = document.createElement('div');
                div.className = 'season-end';
                div.innerHTML = `<strong>Season Complete!</strong><br>You must redraft your squad for the next season.`;
                seasonDiv.appendChild(div);
            }
        }

        function returnToMenu() {
            updateMenuDisplay();
            showScreen('menu-screen');
        }

        // Training failure chance calculation
        function getTrainingRisk(currentStat) {
            if (currentStat <= 8) return { chance: 0, label: 'No Risk' };
            if (currentStat <= 10) return { chance: 0.10, label: 'Low Risk (10%)' };
            if (currentStat <= 12) return { chance: 0.20, label: 'Medium Risk (20%)' };
            if (currentStat <= 14) return { chance: 0.35, label: 'High Risk (35%)' };
            return { chance: 0.50, label: 'Very High Risk (50%)' };
        }

        function attemptTraining(cost, successCallback, failureCallback) {
            gameState.points -= cost;
            
            // Roll for success
            const roll = Math.random();
            // Base success rate depends on training type, modified by stat levels
            
            if (roll > 0) { // Always succeed for now, risk shown in UI
                successCallback();
            } else {
                failureCallback();
            }
        }

        function showTrainingResult(success, message) {
            const modal = document.getElementById('train-result-modal');
            const content = document.getElementById('train-result-content');
            
            content.className = 'train-result ' + (success ? 'success' : 'failure');
            content.innerHTML = success ? 
                `<h3>Training Successful!</h3><p>${message}</p>` : 
                `<h3>Training Failed!</h3><p>${message}</p>`;
            
            modal.classList.add('active');
        }

        function closeTrainResult() {
            document.getElementById('train-result-modal').classList.remove('active');
            showTrainingCamp();
        }

        // Training Camp - Expanded
        function showTrainingCamp() {
            showScreen('training-screen');
            document.getElementById('training-points').textContent = gameState.points;
            
            // Calculate risks for individual training
            let maxAttack = 0, maxDefense = 0, maxPositional = 0;
            gameState.userTeam.forEach(p => {
                maxAttack = Math.max(maxAttack, p.attack);
                maxDefense = Math.max(maxDefense, p.defense);
                maxPositional = Math.max(maxPositional, p.positional);
            });
            
            const attackRisk = getTrainingRisk(maxAttack);
            const defenseRisk = getTrainingRisk(maxDefense);
            const positionalRisk = getTrainingRisk(maxPositional);
            
            document.getElementById('risk-attack').textContent = `Risk: ${attackRisk.label}`;
            document.getElementById('risk-defense').textContent = `Risk: ${defenseRisk.label}`;
            document.getElementById('risk-positional').textContent = `Risk: ${positionalRisk.label}`;
            
            // Individual Training (2 points each)
            document.getElementById('train-attack').className = 'training-option' + (gameState.points < 2 ? ' disabled' : '');
            document.getElementById('train-defense').className = 'training-option' + (gameState.points < 2 ? ' disabled' : '');
            document.getElementById('train-positional').className = 'training-option' + (gameState.points < 2 ? ' disabled' : '');
            
            // Elite Training
            document.getElementById('train-master').className = 'training-option' + (gameState.points < 5 ? ' disabled' : '');
            document.getElementById('train-specialist').className = 'training-option' + (gameState.points < 4 ? ' disabled' : '');
            document.getElementById('train-team').className = 'training-option' + (gameState.points < 6 ? ' disabled' : '');
            
            // Support
            document.getElementById('train-scout').className = 'training-option' + (gameState.points < 3 ? ' disabled' : '');
            document.getElementById('train-intel').className = 'training-option' + (gameState.points < 4 ? ' disabled' : '');
            document.getElementById('train-morale').className = 'training-option' + (gameState.points < 3 ? ' disabled' : '');
        }

        function trainSpecific(attr) {
            const costs = { attack: 2, defense: 2, positional: 2 };
            if (gameState.points < costs[attr]) return;
            
            const modal = document.getElementById('train-modal');
            document.getElementById('train-modal-title').textContent = `Select Player for ${attr.charAt(0).toUpperCase() + attr.slice(1)} Training`;
            const container = document.getElementById('train-players');
            container.innerHTML = '';
            
            gameState.userTeam.forEach((p, idx) => {
                if (p[attr] >= STAT_CAP) return; // Skip if at cap
                
                const risk = getTrainingRisk(p[attr]);
                const btn = document.createElement('button');
                btn.className = 'back-btn';
                btn.style.display = 'block';
                btn.style.width = '100%';
                btn.style.marginBottom = '8px';
                btn.innerHTML = `${p.name} — ${attr}: ${p[attr]} → ${p[attr] + 1}<br><span style="font-size: 10px; color: #888;">${risk.label}</span>`;
                btn.onclick = () => {
                    const roll = Math.random();
                    if (roll > risk.chance) {
                        // Success
                        gameState.points -= costs[attr];
                        gameState.userTeam[idx][attr]++;
                        saveGameState();
                        closeTrainModal();
                        showTrainingResult(true, `${p.name} gained +1 ${attr}!`);
                    } else {
                        // Failure
                        gameState.points -= costs[attr];
                        saveGameState();
                        closeTrainModal();
                        showTrainingResult(false, `Training failed! ${p.name} gains nothing. Points lost.`);
                    }
                };
                container.appendChild(btn);
            });
            
            if (container.innerHTML === '') {
                container.innerHTML = '<p style="color: #666;">All players at maximum stat.</p>';
            }
            
            modal.style.display = 'flex';
        }

        function trainMaster() {
            if (gameState.points < 5) return;
            
            const modal = document.getElementById('train-modal');
            document.getElementById('train-modal-title').textContent = 'Select Player for Master Class (+1 to all stats)';
            const container = document.getElementById('train-players');
            container.innerHTML = '';
            
            gameState.userTeam.forEach((p, idx) => {
                const avgStat = (p.attack + p.defense + p.positional) / 3;
                const risk = getTrainingRisk(Math.floor(avgStat));
                
                const btn = document.createElement('button');
                btn.className = 'back-btn';
                btn.style.display = 'block';
                btn.style.width = '100%';
                btn.style.marginBottom = '8px';
                btn.innerHTML = `${p.name}<br>A:${p.attack} D:${p.defense} P:${p.positional}<br><span style="font-size: 10px; color: #888;">${risk.label}</span>`;
                btn.onclick = () => {
                    const roll = Math.random();
                    if (roll > risk.chance) {
                        gameState.points -= 5;
                        if (p.attack < STAT_CAP) gameState.userTeam[idx].attack++;
                        if (p.defense < STAT_CAP) gameState.userTeam[idx].defense++;
                        if (p.positional < STAT_CAP) gameState.userTeam[idx].positional++;
                        saveGameState();
                        closeTrainModal();
                        showTrainingResult(true, `${p.name} mastered all disciplines!`);
                    } else {
                        gameState.points -= 5;
                        saveGameState();
                        closeTrainModal();
                        showTrainingResult(false, `Master class failed! The player couldn't grasp the concepts.`);
                    }
                };
                container.appendChild(btn);
            });
            
            modal.style.display = 'flex';
        }

        function trainSpecialist() {
            if (gameState.points < 4) return;
            
            const modal = document.getElementById('train-modal');
            document.getElementById('train-modal-title').textContent = 'Select Player and Stat for Specialist Training (+2, max 15)';
            const container = document.getElementById('train-players');
            container.innerHTML = '';
            
            gameState.userTeam.forEach((p, idx) => {
                ['attack', 'defense', 'positional'].forEach(attr => {
                    if (p[attr] < STAT_CAP - 1) {
                        const risk = getTrainingRisk(p[attr] + 1);
                        const btn = document.createElement('button');
                        btn.className = 'back-btn';
                        btn.style.display = 'block';
                        btn.style.width = '100%';
                        btn.style.marginBottom = '8px';
                        const newVal = Math.min(STAT_CAP, p[attr] + 2);
                        btn.innerHTML = `${p.name} — ${attr}: ${p[attr]} → ${newVal}<br><span style="font-size: 10px; color: #888;">${risk.label}</span>`;
                        btn.onclick = () => {
                            const roll = Math.random();
                            if (roll > risk.chance) {
                                gameState.points -= 4;
                                gameState.userTeam[idx][attr] = Math.min(STAT_CAP, gameState.userTeam[idx][attr] + 2);
                                saveGameState();
                                closeTrainModal();
                                showTrainingResult(true, `${p.name} specialized in ${attr}! +2 ${attr}`);
                            } else {
                                gameState.points -= 4;
                                saveGameState();
                                closeTrainModal();
                                showTrainingResult(false, `Specialist training failed! ${p.name} couldn't master the technique.`);
                            }
                        };
                        container.appendChild(btn);
                    }
                });
            });
            
            if (container.innerHTML === '') {
                container.innerHTML = '<p style="color: #666;">All stats too high for specialist training.</p>';
            }
            
            modal.style.display = 'flex';
        }

        function trainTeam() {
            if (gameState.points < 6) return;
            
            const modal = document.getElementById('train-modal');
            document.getElementById('train-modal-title').textContent = 'Select Stat for Team Building (+1 to all 4 players)';
            const container = document.getElementById('train-players');
            container.innerHTML = '';
            
            ['attack', 'defense', 'positional'].forEach(attr => {
                const avgStat = gameState.userTeam.reduce((sum, p) => sum + p[attr], 0) / 4;
                const risk = getTrainingRisk(Math.floor(avgStat));
                
                const btn = document.createElement('button');
                btn.className = 'back-btn';
                btn.style.display = 'block';
                btn.style.width = '100%';
                btn.style.marginBottom = '8px';
                const currentVals = gameState.userTeam.map(p => p[attr]);
                btn.innerHTML = `${attr.toUpperCase()}: ${currentVals.join(', ')} → ${currentVals.map(v => Math.min(STAT_CAP, v + 1)).join(', ')}<br><span style="font-size: 10px; color: #888;">${risk.label}</span>`;
                btn.onclick = () => {
                    const roll = Math.random();
                    if (roll > risk.chance) {
                        gameState.points -= 6;
                        gameState.userTeam.forEach(p => {
                            if (p[attr] < STAT_CAP) p[attr]++;
                        });
                        saveGameState();
                        closeTrainModal();
                        showTrainingResult(true, `Team building successful! All players +1 ${attr}`);
                    } else {
                        gameState.points -= 6;
                        saveGameState();
                        closeTrainModal();
                        showTrainingResult(false, `Team building failed! The squad couldn't sync up.`);
                    }
                };
                container.appendChild(btn);
            });
            
            modal.style.display = 'flex';
        }

        function buyScout() {
            if (gameState.points < 3) return;
            gameState.points -= 3;
            gameState.scoutTokens += 2;
            saveGameState();
            showTrainingCamp();
        }

        function buyIntel() {
            if (gameState.points < 4) return;
            gameState.points -= 4;
            gameState.fullIntel = true;
            saveGameState();
            showTrainingCamp();
        }

        function boostMorale() {
            if (gameState.points < 3) return;
            gameState.points -= 3;
            gameState.moraleBoost = true;
            saveGameState();
            showTrainingCamp();
        }

        function closeTrainModal() {
            document.getElementById('train-modal').style.display = 'none';
        }

        // Squad Swap Functions
        function openSwapModal(playerIndex) {
            if (gameState.swapTokens <= 0) return;
            
            currentSwapIndex = playerIndex;
            const currentPlayer = gameState.userTeam[playerIndex];
            
            document.getElementById('swap-current-stats').innerHTML = 
                `A:${currentPlayer.attack} D:${currentPlayer.defense} P:${currentPlayer.positional}`;
            
            // Generate 3 random options from playerPool (excluding current team)
            const availablePool = playerPool.filter(p => 
                !gameState.userTeam.some(teamP => teamP.name === p.name)
            );
            
            const shuffled = shuffle([...availablePool]);
            const options = shuffled.slice(0, 3);
            
            const container = document.getElementById('swap-options');
            container.innerHTML = '';
            
            options.forEach(player => {
                const card = createPlayerCard(player, () => confirmSwap(player));
                container.appendChild(card);
            });
            
            document.getElementById('swap-modal').style.display = 'flex';
        }

        function confirmSwap(newPlayer) {
            if (currentSwapIndex === null || gameState.swapTokens <= 0) return;
            
            // Replace player
            gameState.userTeam[currentSwapIndex] = {...newPlayer};
            gameState.swapTokens--;
            gameState.swappedPlayers.push({
                replaced: currentSwapIndex,
                timestamp: new Date().toISOString()
            });
            
            saveGameState();
            closeSwapModal();
            viewSquad(); // Refresh squad view
        }

        function closeSwapModal() {
            document.getElementById('swap-modal').style.display = 'none';
            currentSwapIndex = null;
        }

        function viewSquad() {
            if (gameState.userTeam.length < 4) {
                alert('No active squad. Start a match to draft one.');
                return;
            }
            
            showScreen('squad-screen');
            
            const winsNeeded = Math.max(0, 5 - gameState.squadWins);
            const unlockStatus = document.getElementById('unlock-status');
            const swapTokensDisplay = document.getElementById('swap-tokens-display');
            const swapHint = document.getElementById('swap-hint');
            
            if (winsNeeded === 0) {
                unlockStatus.innerHTML = 'Squad is <span style="color: #5bc75b;">UNLOCKED</span>';
                swapTokensDisplay.style.display = 'block';
                document.getElementById('swap-tokens').textContent = gameState.swapTokens;
                
                if (gameState.swapTokens > 0) {
                    swapHint.style.display = 'block';
                    swapHint.textContent = `Click a player to swap them (${gameState.swapTokens} token${gameState.swapTokens !== 1 ? 's' : ''} remaining)`;
                } else {
                    swapHint.style.display = 'none';
                }
            } else {
                unlockStatus.innerHTML = `Wins until unlock: <span id="unlock-wins">${winsNeeded}</span>`;
                swapTokensDisplay.style.display = 'none';
                swapHint.style.display = 'none';
            }
            
            const container = document.getElementById('squad-list');
            container.innerHTML = '';
            
            gameState.userTeam.forEach((p, idx) => {
                const div = document.createElement('div');
                
                // Determine if player can be swapped
                const canSwap = winsNeeded === 0 && gameState.swapTokens > 0;
                
                div.className = 'player-detail';
                if (canSwap) {
                    div.className += ' swappable';
                    div.onclick = () => openSwapModal(idx);
                } else {
                    div.className += ' locked';
                }
                
                div.innerHTML = `
                    <div class="name">${p.name}</div>
                    <div class="stat">
                        <span class="stat-label">Attack</span>
                        <span class="stat-value ${p.attack >= 10 ? 'capped' : ''}">${p.attack}</span>
                    </div>
                    <div class="stat">
                        <span class="stat-label">Defense</span>
                        <span class="stat-value ${p.defense >= 10 ? 'capped' : ''}">${p.defense}</span>
                    </div>
                    <div class="stat">
                        <span class="stat-label">Positional</span>
                        <span class="stat-value ${p.positional >= 10 ? 'capped' : ''}">${p.positional}</span>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function showTutorial() {
            showScreen('tutorial-screen');
            const list = document.getElementById('league-list');
            list.innerHTML = '';
            LEAGUES.forEach((league, idx) => {
                const div = document.createElement('div');
                div.className = 'league-item' + (idx === gameState.currentLeague ? ' current' : '');
                div.textContent = (idx + 1) + '. ' + league;
                list.appendChild(div);
            });
        }

        function selectIdentity(identity) {
            if (gameState.squadLocked && gameState.squadWins < 5) {
                alert('Your squad is locked! Win ' + (5 - gameState.squadWins) + ' more matches to draft a new team.');
                return;
            }

            gameState.identity = identity;
            gameState.availablePlayers = [...playerPool];
            gameState.userTeam = [];
            gameState.draftStep = 0;
            gameState.squadLocked = false;
            gameState.squadWins = 0;
            gameState.swapTokens = 0;
            gameState.swappedPlayers = [];
            
            document.getElementById('current-identity').textContent = identity;
            
            const eligible = gameState.availablePlayers.filter(p => p[identity.toLowerCase()] >= 8);
            const shuffled = shuffle([...eligible]);
            const corePlayers = shuffled.slice(0, 2);
            
            corePlayers.forEach(p => {
                gameState.userTeam.push({...p});
                gameState.availablePlayers = gameState.availablePlayers.filter(x => x.name !== p.name);
            });
            
            gameState.formation = [0, 1, 2, 3];
            
            showScreen('draft-screen');
            updateTeamDisplay();
            
            setTimeout(() => startTacticalRound(1), 100);
        }

        function startTacticalRound(round) {
            gameState.draftStep = round;
            document.getElementById('selection-title').textContent = `Round ${round} — Select 1 of 3`;
            
            const container = document.getElementById('player-options');
            container.innerHTML = '';
            
            const shuffled = shuffle([...gameState.availablePlayers]);
            const choices = shuffled.slice(0, 3);
            
            choices.forEach(player => {
                const card = createPlayerCard(player, () => selectPlayer({...player}));
                container.appendChild(card);
            });
        }

        function createPlayerCard(player, onClick) {
            const div = document.createElement('div');
            div.className = 'player-card';
            div.onclick = onClick;
            
            div.innerHTML = `
                <h4>${player.name}</h4>
                <div class="stat-row">
                    <span class="stat-label">Attack</span>
                    <span class="stat-value ${player.attack >= 8 ? 'high' : ''}">${player.attack}</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Defense</span>
                    <span class="stat-value ${player.defense >= 8 ? 'high' : ''}">${player.defense}</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Positional</span>
                    <span class="stat-value ${player.positional >= 8 ? 'high' : ''}">${player.positional}</span>
                </div>
            `;
            return div;
        }

        function selectPlayer(player) {
            gameState.userTeam.push(player);
            gameState.availablePlayers = gameState.availablePlayers.filter(p => p.name !== player.name);
            updateTeamDisplay();
            
            if (gameState.draftStep === 1) {
                setTimeout(() => startTacticalRound(2), 100);
            } else {
                gameState.squadLocked = true;
                gameState.squadWins = 0;
                saveGameState();
                showFormationScreen();
            }
        }

        function updateTeamDisplay() {
            document.getElementById('team-count').textContent = gameState.userTeam.length;
            
            const container = document.getElementById('team-slots');
            container.innerHTML = '';
            
            for (let i = 0; i < 4; i++) {
                const slot = document.createElement('div');
                slot.className = 'team-slot';
                
                if (i < gameState.userTeam.length) {
                    const p = gameState.userTeam[i];
                    slot.className += ' filled';
                    slot.innerHTML = `
                        <div class="name">${p.name}</div>
                        <div class="stats">A:${p.attack} D:${p.defense} P:${p.positional}</div>
                    `;
                } else {
                    slot.className += ' empty';
                    slot.textContent = 'Empty';
                }
                container.appendChild(slot);
            }
        }

        function generateAITeam() {
            const difficulty = getAIDifficulty();
            const identities = ['Attack', 'Defense', 'Positional'];
            const aiIdentity = identities[Math.floor(Math.random() * 3)];
            
            let pool = [...playerPool];
            let team = [];
            
            // Generate 4 players with stats around target average
            for (let i = 0; i < 4; i++) {
                // Pick base player
                const basePlayer = pool[Math.floor(Math.random() * pool.length)];
                pool = pool.filter(p => p.name !== basePlayer.name);
                
                // Create modified copy with scaled stats
                const player = {...basePlayer};
                
                // Scale each stat toward target average with variance
                ['attack', 'defense', 'positional'].forEach(attr => {
                    const target = difficulty.targetAvg + (Math.random() * difficulty.variance * 2 - difficulty.variance);
                    const current = player[attr];
                    // Blend current with target
                    let newVal = Math.round((current + target) / 2);
                    // Add some randomness
                    newVal += Math.floor(Math.random() * 3) - 1;
                    // Clamp
                    newVal = Math.max(difficulty.minStat, Math.min(difficulty.maxStat, newVal));
                    player[attr] = newVal;
                });
                
                team.push(player);
            }
            
            gameState.aiTeam = shuffle(team);
        }

        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        function shuffle(array) {
            const arr = [...array];
            for (let i = arr.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [arr[i], arr[j]] = [arr[j], arr[i]];
            }
            return arr;
        }

        init();
    </script>
</body>
</html>
